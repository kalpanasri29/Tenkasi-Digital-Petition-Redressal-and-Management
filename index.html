<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenkasi District Administration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); position: relative; }
        .header h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2.2em; font-weight: 700; }
        .header p { color: #7f8c8d; font-size: 1.05em; }
        .nav-buttons { display: flex; gap: 15px; justify-content: center; margin: 20px 0; }
        .nav-btn { padding: 12px 25px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 14px; }
        .nav-btn.primary { background: linear-gradient(45deg, #3498db, #2980b9); color: white; }
        .nav-btn.warning { background: linear-gradient(45deg, #fbd38d, #f6ad55); color: #5a3e00; border: 1px solid #f6ad55; }
        .nav-btn.accent { background: linear-gradient(45deg, #ffd7ba, #ffbfa3); color: #6b3a1e; border: 1px solid #ffc6a8; }
        .nav-btn.secondary { background: rgba(255, 255, 255, 0.2); color: #2c3e50; border: 2px solid rgba(255, 255, 255, 0.3); }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,.2); }
        .lang-toggle { position: absolute; right: 16px; top: 16px; display: flex; gap: 6px; }
        .lang-btn { padding: 6px 10px; border-radius: 16px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-weight: 600; font-size: 12px; }
        .lang-btn.active { background: #111827; color: #fff; border-color: #111827; }
        .card { background: rgba(255, 255, 255, 0.96); backdrop-filter: blur(8px); border-radius: 20px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,.08); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-inline { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #e1e8ed; border-radius: 12px; font-size: 14px; transition: border-color .3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .hint { font-size: 12px; color: #7f8c8d; margin-top: 6px; }
        .submit-btn { background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 14px 22px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 15px; width: 100%; transition: .3s; }
        .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(46,204,113,.25); }
        .hidden { display: none; }
        .type-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f7f9fc; padding: 8px; border-radius: 12px; border: 1px solid #e6eef7; }
        .type-btn { background: white; border: 2px solid #dbe7f6; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer; transition: .2s; text-align: center; }
        .type-btn.active { background: linear-gradient(45deg, #6366f1, #3b82f6); color: #fff; border-color: transparent; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .thumb { position: relative; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .thumb img { width: 100%; height: 100px; object-fit: cover; display: block; }
        .thumb button { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,.6); color: #fff; border: 0; border-radius: 6px; padding: 4px 6px; cursor: pointer; }
        .ack { display: flex; align-items: center; justify-content: space-between; gap: 12px; background: rgba(46,204,113,.1); border: 1px solid #2ecc71; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; }
        .status-badge { padding: 6px 15px; border-radius: 20px; font-weight: 600; font-size: 12px; text-transform: uppercase; }
        .status-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-in-progress { background: #cce5ff; color: #004085; border: 1px solid #74b9ff; }
        .status-resolved { background: #d4edda; color: #155724; border: 1px solid #00b894; }
        .status-rejected { background: #f8d7da; color: #721c24; border: 1px solid #e74c3c; }
        .status-validating { background: #e8f0fe; color: #1a73e8; border: 1px solid #bcd2ff; }
        .status-accepted { background: #e6fffa; color: #0d9488; border: 1px solid #99f6e4; }
        .filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .update-btn { background: #3498db; color: #fff; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .update-btn.secondary { background: #6b7280; }
        @media (max-width: 768px) { .nav-buttons { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="lang-toggle">
                <button id="lang-en" class="lang-btn active" onclick="setLang('en')">English</button>
                <button id="lang-ta" class="lang-btn" onclick="setLang('ta')">தமிழ்</button>
            </div>
            <h1 data-i18n="title">🏛️ Tenkasi District Administration</h1>
            <p data-i18n="tagline">Digital Petition Redressal Mechanism</p>
            <div class="nav-buttons">
                <button class="nav-btn primary" onclick="showSection('public')" data-i18n="nav.file">📝 File Petition/Complaint</button>
                <button class="nav-btn secondary" onclick="showSection('track')" data-i18n="nav.track">🔎 Track Petition/Complaint</button>
                <button class="nav-btn warning" onclick="showSection('dcdm-login')" data-i18n="nav.dcdm">🏢 DC/DM Login</button>
                <button class="nav-btn accent" onclick="showSection('admin-login')" data-i18n="nav.official">🔐 Official Login</button>
            </div>
        </div>

        <!-- Public Form -->
        <div id="public-section" class="card">
            <div id="submission-preview" class="hidden" style="margin-bottom:16px;"></div>
            <h2 style="margin-bottom: 16px; color: #2c3e50;" data-i18n="form.title">📝 New Petition/Complaint</h2>
            <form id="complaint-form">
                <div class="form-group">
                    <label data-i18n="form.type">Submission Type</label>
                    <div class="type-toggle">
                        <button type="button" id="btn-complaint" class="type-btn active" onclick="setType('complaint')" data-i18n="form.civic">Civic Complaint</button>
                        <button type="button" id="btn-petition" class="type-btn" onclick="setType('petition')" data-i18n="form.petition">Petition</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="complainant-name" data-i18n="form.name">Your Name</label>
                    <input type="text" id="complainant-name" required>
                </div>
                <div class="form-group">
                    <label for="complainant-phone" data-i18n="form.phone">Phone Number</label>
                    <input type="tel" id="complainant-phone" required placeholder="Enter your mobile number">
                    <div class="hint">Only one submission is allowed per phone number in a 7-day period.</div>
                </div>
                <div class="form-group">
                    <label for="complainant-email" data-i18n="form.email">Email Address</label>
                    <input type="email" id="complainant-email" placeholder="Optional">
                </div>

                <div class="form-group" id="category-group">
                    <label for="complaint-category" data-i18n="form.category">Category (for Civic Complaint)</label>
                    <select id="complaint-category">
                        <option value="">Select Category</option>
                        <option value="road-maintenance">🛣️ Road Maintenance</option>
                        <option value="water-supply">💧 Water Supply</option>
                        <option value="garbage-collection">🗑️ Garbage Collection</option>
                        <option value="street-lighting">💡 Street Lighting</option>
                        <option value="drainage">🌊 Drainage Issues</option>
                        <option value="public-transport">🚌 Public Transport</option>
                        <option value="noise-pollution">🔊 Noise Pollution</option>
                        <option value="other">📋 Other</option>
                    </select>
                </div>
                <div class="form-group hidden" id="department-group">
                    <label for="petition-department" data-i18n="form.department">Department (for Petition)</label>
                    <select id="petition-department">
                        <option value="">Select Department</option>
                        <option value="revenue">🏢 Revenue Department</option>
                        <option value="rural-development">🏡 Rural Development & Panchayat Raj</option>
                        <option value="municipal-administration">🏙️ Municipal Administration</option>
                        <option value="public-works">🏗️ Public Works (PWD)</option>
                        <option value="highways">🛣️ Highways</option>
                        <option value="health">🏥 Health & Family Welfare</option>
                        <option value="school-education">🎒 School Education</option>
                        <option value="higher-education">🎓 Higher Education</option>
                        <option value="social-welfare">🤝 Social Welfare</option>
                        <option value="agriculture">🌾 Agriculture</option>
                        <option value="horticulture">🌱 Horticulture</option>
                        <option value="animal-husbandry">🐄 Animal Husbandry</option>
                        <option value="forest">🌳 Forest</option>
                        <option value="police">👮 Police</option>
                        <option value="fire-rescue">🚒 Fire & Rescue</option>
                        <option value="electricity">⚡ TANGEDCO (Electricity)</option>
                        <option value="transport">🚌 Transport</option>
                        <option value="registration">📝 Registration</option>
                        <option value="other">📋 Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label data-i18n="form.location">Location</label>
                    <div class="form-inline">
                        <select id="taluk-select" required><option value="">Select Taluk</option></select>
                        <select id="firka-select" required disabled><option value="">Select Firka</option></select>
                        <select id="village-select" required disabled><option value="">Select Village</option></select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="complaint-description" data-i18n="form.description">Detailed Description</label>
                    <textarea id="complaint-description" placeholder="Provide detailed information..." required></textarea>
                </div>

                <div id="photos-section" class="form-group">
                    <label data-i18n="form.photos">Photos (for Civic Complaint)</label>
                    <input type="file" id="photo-input" accept="image/*" multiple>
                    <div id="photo-preview" class="photo-grid" style="margin-top:10px;"></div>
                </div>

                <div class="form-group">
                    <label for="urgency-level" data-i18n="form.urgency">Urgency Level</label>
                    <select id="urgency-level" required>
                        <option value="low">🟢 Low</option>
                        <option value="medium">🟡 Medium</option>
                        <option value="high">🔴 High</option>
                    </select>
                </div>

                <button type="submit" class="submit-btn">Submit</button>
            </form>
        </div>

        <!-- DC/DM PIN Login (replaces public view) -->
        <div id="dcdm-login-section" class="card hidden">
            <h2 style="margin-bottom: 12px; color:#2c3e50;">🏢 DC/DM Login</h2>
            <form id="dcdm-login-form" class="form-inline" style="grid-template-columns: 1fr auto;">
                <input type="password" id="dcdm-pin" placeholder="Enter Unique PIN" required>
                <button class="update-btn" type="submit">Login</button>
            </form>
            <div id="dcdm-panel" class="hidden" style="margin-top:16px;">
                <div class="filters" style="margin-bottom:10px;">
                    <select id="dcdm-type-filter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="complaint">Complaints</option>
                        <option value="petition">Petitions</option>
                    </select>
                    <select id="dcdm-status-filter" class="filter-select">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="validating">Validating</option>
                        <option value="accepted">Accepted</option>
                        <option value="resolved">Resolved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <select id="dcdm-taluk-filter" class="filter-select"><option value="">All Taluks</option></select>
                    <select id="dcdm-firka-filter" class="filter-select" disabled><option value="">All Firkas</option></select>
                    <select id="dcdm-village-filter" class="filter-select" disabled><option value="">All Villages</option></select>
                    <input type="text" id="dcdm-search" class="filter-select" placeholder="Search...">
                </div>
                <div id="dcdm-list"></div>
            </div>
        </div>

        <!-- Official Login -->
        <div id="admin-login-section" class="card hidden">
            <div class="login-form">
                <h2 style="margin-bottom: 16px; color: #2c3e50; text-align: center;">🔐 Official Login</h2>
                <form id="admin-login-form">
                    <div class="form-group">
                        <label for="admin-username">Username</label>
                        <input type="text" id="admin-username" placeholder="Username" required>
                    </div>
                    <div class="form-group">
                        <label for="admin-password">Password</label>
                        <input type="password" id="admin-password" placeholder="Password" required>
                    </div>
                    <button type="submit" class="submit-btn">Login</button>
                </form>
            </div>
        </div>

        <!-- Official Dashboard -->
        <div id="admin-section" class="card hidden">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px;">
                <h2 style="color:#2c3e50;">🛠️ Official Dashboard</h2>
                <button class="nav-btn secondary" onclick="logout()">Logout</button>
            </div>
            <div class="filters" style="margin-bottom:12px;">
                <select id="admin-type-filter" class="filter-select"><option value="">All Types</option><option value="complaint">Complaints</option><option value="petition">Petitions</option></select>
                <select id="admin-status-filter" class="filter-select"><option value="">All Status</option><option value="in-progress">In Progress</option><option value="validating">Validating</option><option value="accepted">Accepted</option><option value="resolved">Resolved</option><option value="rejected">Rejected</option><option value="pending">Pending</option></select>
                <select id="admin-taluk-select" class="filter-select"><option value="">All Taluks</option></select>
                <select id="admin-firka-select" class="filter-select" disabled><option value="">All Firkas</option></select>
                <select id="admin-village-select" class="filter-select" disabled><option value="">All Villages</option></select>
                <input type="text" id="admin-search-box" class="filter-select" placeholder="Search...">
            </div>
            <div id="admin-complaints-list"></div>
        </div>

        <!-- Citizen Track (Phone + ID) -->
        <div id="track-section" class="card hidden">
            <h2 style="margin-bottom: 12px; color:#2c3e50;" data-i18n="track.title">🔎 Track Petition/Complaint</h2>
            <div class="form-inline" style="grid-template-columns: 1fr 1fr auto auto;">
                <input type="tel" id="track-phone" placeholder="Phone number" required>
                <input type="text" id="track-id" placeholder="Reference ID (e.g., CMP004)" required>
                <button class="update-btn" onclick="trackByPhoneAndId()">View</button>
                <button class="update-btn secondary" onclick="downloadTrackAck()">Download Acknowledgement</button>
            </div>
            <div id="track-result" style="margin-top:12px;"></div>
        </div>
    </div>

    <script>
        // API base
        const API = '';
        let LANG = 'en';
        const I18N = {
            en: {
                title: '🏛️ Tenkasi District Administration',
                tagline: 'Digital Petition Redressal Mechanism',
                nav: { file: '📝 File Petition/Complaint', track: '🔎 Track Petition/Complaint', dcdm: '🏢 DC/DM Login', official: '🔐 Official Login' },
                form: { title: '📝 New Petition/Complaint', type: 'Submission Type', civic: 'Civic Complaint', petition: 'Petition', name: 'Your Name', phone: 'Phone Number', email: 'Email Address', category: 'Category (for Civic Complaint)', department: 'Department (for Petition)', location: 'Location', description: 'Detailed Description', photos: 'Photos (for Civic Complaint)', urgency: 'Urgency Level' },
                track: { title: '🔎 Track Petition/Complaint' }
            },
            ta: {
                title: '🏛️ தென்காசி மாவட்ட ஆட்சி',
                tagline: 'மின்னணு மனு தீர்வு அமைப்பு',
                nav: { file: '📝 மனு/புகார் சமர்ப்பிக்க', track: '🔎 மனு/புகார் கண்காணிக்க', dcdm: '🏢 ஆட்சியர் உள்நுழைவு', official: '🔐 அதிகாரி உள்நுழைவு' },
                form: { title: '📝 புதிய மனு/புகார்', type: 'சமர்ப்பிப்பு வகை', civic: 'சிவிக் புகார்', petition: 'மனு', name: 'பெயர்', phone: 'தொலைபேசி எண்', email: 'மின்னஞ்சல்', category: 'புகார் வகை', department: 'துறை (மனு)', location: 'இடம்', description: 'விரிவான விளக்கம்', photos: 'புகைப்படங்கள் (புகார்)', urgency: 'அவசர நிலை' },
                track: { title: '🔎 மனு/புகார் கண்காணிக்க' }
            }
        };
        function setLang(lang){ LANG = lang; document.getElementById('lang-en').classList.toggle('active', lang==='en'); document.getElementById('lang-ta').classList.toggle('active', lang==='ta');
            const dict = I18N[lang];
            document.querySelectorAll('[data-i18n]').forEach(el=>{ const key = el.getAttribute('data-i18n'); const parts = key.split('.'); let val = dict; parts.forEach(p=>{ if (val) val = val[p]; }); if (val) el.innerText = val; });
        }
        let currentType = 'complaint';
        let isAdmin = false;
        const SUBMISSIONS_KEY = 'tenkasi_submissions_by_phone_v1';

        // Locations
        const locations = {
          "Tenkasi": {
            "Kallurani": [
              "Sundarapandiapuram","Thiruchitrambalam","Melapavoor","Pattakuruchi","Gunaramanallur",
              "Kulasekarapatti","Kallurani","Thippanampatti","Avudaiyannur"
            ],
            "Tenkasi": [
              "Pulliyur","Tenkasi","Kuthukkalvalasai","Ilanji","Courtrallam","Melagaram",
              "Pattapathu","Minnadicheri","Ayiraperi","Mathalamparai","Sillaraipuravu"
            ],
            "Kadayam": [
              "Mela Kadaiyam","Therkku Madathur","Ayan Pottalpudhur","Therkku Kadaiyam","Veerasamudram",
              "Ravanasamudram","Govindaperi","Ayan Dharmapuramadam","Kadaiyam Perumpathu Part-1",
              "Kadaiyam Perumpathu Part-2","Keela Kadaiyam Part-1","Keela Kadaiyam Part-2"
            ],
            "Alwarkurichi": [
              "Sivasailam","Keela Ambur","Vadakku Pappankulam","Adaichani","Alwarkurichi Part-1",
              "Alwarkurichi Part-2","Mela Ambur Part-1","Mela Ambur Part-2"
            ]
          },
          "Kadayanallur": {
            "Puliyangudi": [
              "Nagaram","Malayadikkurichi","Chinthamani","Puliyangudi","Melapuliyankudi",
              "Thirumalainayakan Pudukudi","Thalaivankottai","Ramasamiyapuram","Alangulam"
            ],
            "Kadayanallur": [
              "Vairavankulam","Krishnapuram","Chokkampatti","Boganallur","Kanagasabapathiperi",
              "Kadayanallur","Kasitharmam","Punnaivanam","Madathupatti","Ariyanayagipuram",
              "Sendamangalam","Achanpudur","Kampaneri Pudukudi Part-1","Kampaneri Pudukudi Part-2"
            ],
            "Ayikudi": [
              "Idaikal","Nainaragaram","Kilangadu","Kodikkurichi","Ayikudi","Urmelaalagiyaan","Poigai","Sambavar Vadakarai"
            ]
          },
          "Thiruvengadam": {
            "Karisalkulam": ["Malaiyan Kulam","Perungkottur","Chandirangondan","Azagapuri","Chavelkulam","Mathurapuri","A.Mathurapuri","A.Kariselkulam","Karisathan","Kulasekarapperi","Rengasamudram","Subbaiah Puram","Chathirapatti","Kalingapatti Part-1","Kalingapatti Part-2"],
            "Thiruvengadam": ["Thiruvengadam","Vellakulam","Kurinchakulam","Sangupatti","Maipparai","Varaganoor","Naduvappatti","Kulakkattakurichi","Sundaresapuram","Vadakku Kuruvikulam","Ramalinga Puram","Athippatti","Vagaikulam"],
            "Pazhankottai": ["K.Alangulam","Therku Kuruvikulam","Naluvasan Kottai","Pazhankottai","Usilangulam","Chettikulam","Mahendravadi","Maruthan Ginaru","Kalappalangulam","Nalanthula","K.Karisalkulam","Sayamalai Part-1","Sayamalai Part-2"]
          },
          "Sankarankoil": {
            "Karivalamvanthanallur": ["Perumalpatti","Valavanthapuram","Panthapuli","Paruvakudi","Karivalamvantha Nallur","Vayali","Kuvalaikanni","Panaiyoor","Periyoor"],
            "Sernthamangalam": ["Kulasekaramangalum","Vellalankulam","Yechantha","Pattadaikatti","Naduvakurichi-Major"],
            "Sankarankoil": ["Perumpathur","Manaloor","Vadikkottai","Kalappakulam","Sankarankovil"],
            "Veerasigamani": ["Vaddakuputhur","Veeriruppu","Nochikulam","Therku Sankarankovil","Poigai","Veerasigamani","Keelaveerasigamani"],
            "Gurukkalpatti": ["Naduvakurichi-Minor","Chinnakovilan Kulam","Periyakovilan Kulam","K.Maruthappapuram","Gurukkalpatti","Vadakku Panai Vadali","Keelaneelithanallur","Melaneelithanallur","Ilanthaikulam"]
          },
          "Shencottai": {
            "Shencottai": ["Nagalkadu","Pudur","Puliyarai","Karkudi","Sengottai Town","Sengottai Keelur","Sengottai Melur"],
            "Panpozhi": ["Mekkarai","Vadakarai Melpidagai","Vadakarai Keelpidagai","Panpoli","Thenpothai","Kanakkapillaivalasai","Periyapillaivalasai"],
            "Ilanthur": ["Neduvayal","Elathur","Kunnakudy","Piranoor","Vallam"]
          },
          "Veerakeralampudur": {
            "Veerakeralampudur": ["Vellakal","Veerakeralampudur","Rajagopalaperi","Agaram","Veeranam"],
            "Surandai": ["Kulayaneri","Sivagurunathapuram","Anaikulam","Zamin Surandai","Surandai Part-I","Surandai Part-II"],
            "Karuvantha": ["Melakalangal","Keelakalangal","Navaneethakrishnapuram","Kurichanpatti","Karuvantha","Vadi","Achankuttam"],
            "Uthumalai": ["Vadakkukavalakurichi","Uthumalai","Melamarudappapuram","Balapathiraramapuram","Marukkalankulam","Muthammalpuram"]
          },
          "Alangulam": {
            "Keelapavoor": ["Kaluneerkulam","Thuthikulam","Poolankulam","Keelapavoor Part-1","Keelapavoor Part-2","Pethanadarpatti Part-1","Pethanadarpatti Part-2"],
            "Nettur": ["Kidarakulam","Kasikkuvaithan","Kavalakuruchi","Kadanganeri","Kaduvetti","Subbiahpuram","Nettur","Naranapuram"],
            "Vengadampatti": ["Madathur","Anainthaperumalnadanur","Thuppakudi","Ravuthaperi","Anjankattalai","Venkadampatti Part-1","Venkadampatti Part-2"],
            "Puthupatti": ["Kuthapanjan","Odaimarichchan","Udaiyampuli","Pudupatti Part-1","Pudupatti Part-2","Maruthamputhur Part-1","Maruthamputhur Part-2"],
            "Alangulam": ["Mayamankuruchi","Ayyanarkulam","Sivalarkulam","Alangulam","Andipatti","Maranthai"]
          },
          "Sivagiri": {
            "Sivagiri": ["Ramanathapuram","Sivagiri - Part-1","Sivagiri - Part-2","Rayagiri - Part-1","Rayagiri - Part-2","Viswanathaperi - Part-1","Viswanathaperi - Part-2"],
            "Cuddalore": ["Inamkovilpatti","Cuddalor","Nelkkattumseval","Patakurichi","Ariyur","Thenmalai - Part-1","Thenmalai - Part-2"],
            "Vasudevanallur": ["Thirumalapuram","Vasudevanallur","Subramaniyapuram","Dharugapuram","Sanganaperi","Naranapuram - Part-1","Naranapuram - Part-2"]
          }
        };

        function setType(type) {
            currentType = type;
            document.getElementById('btn-complaint').classList.toggle('active', type==='complaint');
            document.getElementById('btn-petition').classList.toggle('active', type==='petition');
            document.getElementById('category-group').classList.toggle('hidden', type!=='complaint');
            document.getElementById('department-group').classList.toggle('hidden', type!=='petition');
            document.getElementById('photos-section').classList.toggle('hidden', type!=='complaint');
        }

        function normalizePhone(raw) { const digits = String(raw || '').replace(/\D/g, ''); return digits.length >= 10 ? digits.slice(-10) : digits; }
        function getSubmissionsMap() { try { return JSON.parse(localStorage.getItem(SUBMISSIONS_KEY)) || {}; } catch { return {}; } }
        function setSubmissionsMap(map) { localStorage.setItem(SUBMISSIONS_KEY, JSON.stringify(map)); }
        function isEligibleToSubmit(phone) { const ts = getSubmissionsMap()[phone]; if (!ts) return true; const ONE_WEEK_MS = 7*24*60*60*1000; return (Date.now()-ts) >= ONE_WEEK_MS; }
        function recordSubmission(phone) { const map = getSubmissionsMap(); map[phone] = Date.now(); setSubmissionsMap(map); }

        // Photos handling
        const selectedPhotos = [];
        function setupPhotoInput() {
            const input = document.getElementById('photo-input');
            const preview = document.getElementById('photo-preview');
            input.addEventListener('change', async () => {
                for (const file of input.files) {
                    const dataUrl = await fileToDataURL(file);
                    selectedPhotos.push(dataUrl);
                }
                renderPhotos();
                input.value = '';
            });
            function renderPhotos() {
                preview.innerHTML = selectedPhotos.map((src, idx) => `<div class="thumb"><img src="${src}"><button onclick="removePhoto(${idx})">✕</button></div>`).join('');
            }
            window.removePhoto = (idx) => { selectedPhotos.splice(idx,1); renderPhotos(); };
            function fileToDataURL(file) { return new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(file); }); }
        }

        // Populate location selects (public/admin/dcdm)
        function setupLocationDropdowns() {
            const talukSelect = document.getElementById('taluk-select');
            const firkaSelect = document.getElementById('firka-select');
            const villageSelect = document.getElementById('village-select');
            const reset = (sel, txt) => { sel.innerHTML = `<option value="">${txt}</option>`; };
            reset(talukSelect,'Select Taluk'); Object.keys(locations).forEach(t=>talukSelect.innerHTML += `<option>${t}</option>`);
            talukSelect.addEventListener('change', () => { reset(firkaSelect,'Select Firka'); reset(villageSelect,'Select Village'); villageSelect.disabled=true; const t=talukSelect.value; if(!t){firkaSelect.disabled=true;return;} Object.keys(locations[t]).forEach(f=>firkaSelect.innerHTML+=`<option>${f}</option>`); firkaSelect.disabled=false; });
            firkaSelect.addEventListener('change', () => { reset(villageSelect,'Select Village'); const t=talukSelect.value,f=firkaSelect.value; if(!t||!f){villageSelect.disabled=true;return;} (locations[t][f]||[]).forEach(v=>villageSelect.innerHTML+=`<option>${v}</option>`); villageSelect.disabled=false; });
        }

        // DC/DM cascading
        function setupDcdmLocation() {
            const t = document.getElementById('dcdm-taluk-filter');
            const f = document.getElementById('dcdm-firka-filter');
            const v = document.getElementById('dcdm-village-filter');
            const reset = (sel, txt) => { sel.innerHTML = `<option value="">${txt}</option>`; };
            reset(t,'All Taluks'); Object.keys(locations).forEach(x=>t.innerHTML += `<option>${x}</option>`);
            t.addEventListener('change', ()=>{ reset(f,'All Firkas'); reset(v,'All Villages'); v.disabled=true; if(!t.value){f.disabled=true; loadDcdmList(); return;} Object.keys(locations[t.value]).forEach(x=>f.innerHTML+=`<option>${x}</option>`); f.disabled=false; loadDcdmList(); });
            f.addEventListener('change', ()=>{ reset(v,'All Villages'); if(!t.value||!f.value){v.disabled=true; loadDcdmList(); return;} (locations[t.value][f.value]||[]).forEach(x=>v.innerHTML+=`<option>${x}</option>`); v.disabled=false; loadDcdmList(); });
            v.addEventListener('change', loadDcdmList);
        }

        // Admin cascading
        function setupAdminLocation() {
            const t = document.getElementById('admin-taluk-select');
            const f = document.getElementById('admin-firka-select');
            const v = document.getElementById('admin-village-select');
            const reset = (sel, txt) => { sel.innerHTML = `<option value="">${txt}</option>`; };
            reset(t,'All Taluks'); Object.keys(locations).forEach(x=>t.innerHTML += `<option>${x}</option>`);
            t.addEventListener('change', ()=>{ reset(f,'All Firkas'); reset(v,'All Villages'); v.disabled=true; if(!t.value){f.disabled=true; displayAdminList(); return;} Object.keys(locations[t.value]).forEach(x=>f.innerHTML+=`<option>${x}</option>`); f.disabled=false; displayAdminList(); });
            f.addEventListener('change', ()=>{ reset(v,'All Villages'); if(!t.value||!f.value){v.disabled=true; displayAdminList(); return;} (locations[t.value][f.value]||[]).forEach(x=>v.innerHTML+=`<option>${x}</option>`); v.disabled=false; displayAdminList(); });
            v.addEventListener('change', displayAdminList);
        }

        // Helpers
        function getCategoryLabel(category) { const m = {'road-maintenance':'🛣️ Road Maintenance','water-supply':'💧 Water Supply','garbage-collection':'🗑️ Garbage Collection','street-lighting':'💡 Street Lighting','drainage':'🌊 Drainage Issues','public-transport':'🚌 Public Transport','noise-pollution':'🔊 Noise Pollution','other':'📋 Other'}; return m[category]||category||''; }
        function getDepartmentLabel(dept) { const m = {'revenue':'🏢 Revenue Department','rural-development':'🏡 Rural Development & Panchayat Raj','municipal-administration':'🏙️ Municipal Administration','public-works':'🏗️ Public Works (PWD)','highways':'🛣️ Highways','health':'🏥 Health & Family Welfare','school-education':'🎒 School Education','higher-education':'🎓 Higher Education','social-welfare':'🤝 Social Welfare','agriculture':'🌾 Agriculture','horticulture':'🌱 Horticulture','animal-husbandry':'🐄 Animal Husbandry','forest':'🌳 Forest','police':'👮 Police','fire-rescue':'🚒 Fire & Rescue','electricity':'⚡ TANGEDCO (Electricity)','transport':'🚌 Transport','registration':'📝 Registration','other':'📋 Other'}; return m[dept]||dept||''; }
        function getUrgencyLabel(u){return {'low':'🟢 Low','medium':'🟡 Medium','high':'🔴 High'}[u]||u}

        function buildCard(item, showOfficialControls=false) {
            const typeLabel = item.type==='petition' ? 'Petition' : 'Civic Complaint';
            const labelName = item.type==='petition' ? 'Department' : 'Category';
            const labelVal = item.type==='petition' ? getDepartmentLabel(item.department) : getCategoryLabel(item.category);
            const photos = (item.photos||[]).map(src=>`<img src="${src}" style="width:80px;height:60px;object-fit:cover;border:1px solid #eee;border-radius:6px;margin-right:6px;">`).join('');
            const statusBadge = `<span class="status-badge status-${item.status}">${item.status.replace('-',' ')}</span>`;
            const history = (item.history || []).map(h => {
                const ts = new Date(h.timestamp || h.ts || Date.now()).toLocaleString();
                const st = (h.status || '').replace('-', ' ');
                const resp = h.response ? ` — ${h.response}` : '';
                return `<div style="font-size:12px;color:#4b5563;">${ts}: ${st}${resp}</div>`;
            }).join('');
            const resolved = item.resolved_at ? `<div style="font-size:12px;color:#065f46;">Resolved at: ${new Date(item.resolved_at).toLocaleString()}</div>` : '';
            const controls = showOfficialControls ? `
        <div class="form-inline" style="margin-top:8px;">
            <select id="st-${item.id}" class="filter-select">
                ${getStatusOptions(item.type).map(s=>`<option value="${s.value}" ${item.status===s.value?'selected':''}>${s.label}</option>`).join('')}
            </select>
            <input type="text" id="resp-${item.id}" class="filter-select" placeholder="Acknowledgement / Response (optional)">
            <button class="update-btn" onclick="updateStatus('${item.id}')">Update</button>
            <button class="update-btn secondary" onclick="downloadAcknowledgement('${item.id}')">Download Acknowledgement</button>
        </div>
        <div id="live-${item.id}" style="margin-top:8px;"></div>` : `<div style="margin-top:8px;"><button class="update-btn" onclick="downloadAcknowledgement('${item.id}')">Download Acknowledgement</button></div>`;
            return `<div class="card" id="item-${item.id}">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                    <div style="font-weight:700;color:#2c3e50;">${item.id}</div>
                    ${statusBadge}
                </div>
                <div class="form-inline" style="margin-top:8px;">
                    <div><strong>Type:</strong> ${typeLabel}</div>
                    <div><strong>${labelName}:</strong> ${labelVal}</div>
                    <div><strong>Location:</strong> ${item.taluk} / ${item.firka} / ${item.village}</div>
                    <div><strong>Urgency:</strong> ${getUrgencyLabel(item.urgency)}</div>
                    <div><strong>Submitted:</strong> ${new Date(item.timestamp).toLocaleString()}</div>
                </div>
                <div style="margin-top:6px;"><strong>Description:</strong><br>${item.description}</div>
                ${photos?`<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;">${photos}</div>`:''}
                ${resolved}
                ${history?`<div style=\"margin-top:8px;\"><strong>History:</strong><div style=\"margin-top:4px;display:flex;flex-direction:column;gap:2px;\">${history}</div></div>`:''}
                ${controls}
            </div>`;
        }
        function getStatusOptions(type){ return type==='petition' ? [
            {value:'in-progress',label:'In Progress'},{value:'validating',label:'Validating'},{value:'accepted',label:'Accepted'},{value:'resolved',label:'Resolved'}
        ] : [ {value:'in-progress',label:'In Progress'},{value:'rejected',label:'Rejected'},{value:'resolved',label:'Resolved'} ]; }

        async function createSubmission(payload){
            await fetch(`${API}/api/submissions`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        }
        async function listSubmissions(params){
            const qs = new URLSearchParams(params||{}).toString();
            const r = await fetch(`${API}/api/submissions?${qs}`);
            return r.json();
        }
        async function lookupSubmission(id, phone){
            const qs = new URLSearchParams({id,phone}).toString();
            const r = await fetch(`${API}/api/submissions/lookup?${qs}`);
            return r.json();
        }
        async function setStatus(id, status, response){
            await fetch(`${API}/api/submissions/${id}/status`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status, response})});
        }

        function showSection(section){
            ['public','dcdm-login','admin-login','admin','track'].forEach(s=>document.getElementById(`${s}-section`).classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
            if(section==='admin') displayAdminList(); if(section==='dcdm-login') loadDcdmList();
        }

        // Form submit
        function setupForm(){
            document.getElementById('complaint-form').addEventListener('submit', async (e)=>{
                e.preventDefault();
                const name = document.getElementById('complainant-name').value.trim();
                const email = document.getElementById('complainant-email').value.trim();
                const phoneRaw = document.getElementById('complainant-phone').value.trim();
                const phone = normalizePhone(phoneRaw);
                if(!phone){ alert('Phone is required'); return; }
                if(!isEligibleToSubmit(phone)){ alert('You can submit only once in 7 days from this number.'); return; }
                const taluk = document.getElementById('taluk-select').value;
                const firka = document.getElementById('firka-select').value;
                const village = document.getElementById('village-select').value;
                if(!taluk||!firka||!village){ alert('Select Taluk, Firka and Village'); return; }
                const description = document.getElementById('complaint-description').value.trim();
                const urgency = document.getElementById('urgency-level').value;
                const id = `CMP${Date.now().toString().slice(-8)}`;
                const payload = { id, type: currentType, name, email, phone: phoneRaw, taluk, firka, village, description, urgency, status: 'pending' };
                if(currentType==='petition') { const department=document.getElementById('petition-department').value; if(!department){alert('Choose Department');return;} payload.department=department; }
                else { const category=document.getElementById('complaint-category').value; if(!category){alert('Choose Category');return;} payload.category=category; payload.photos=[...selectedPhotos]; }
                try{
                    await createSubmission(payload);
                    recordSubmission(phone);

                    // Show inline preview and acknowledgement actions
                    const previewBox = document.getElementById('submission-preview');
                    const itemForPreview = { ...payload, timestamp: new Date().toISOString() };
                    previewBox.classList.remove('hidden');
                    previewBox.innerHTML = `
                        <div class="ack">
                            <div>Submitted successfully. Your reference ID is <strong>${id}</strong></div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="update-btn" onclick="downloadAcknowledgement('${id}')">Open Acknowledgement</button>
                                <button class="update-btn secondary" onclick="navigator.clipboard && navigator.clipboard.writeText('${id}')">Copy ID</button>
                            </div>
                        </div>
                        ${buildCard(itemForPreview, false)}
                    `;
                    previewBox.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    // Reset form for next submission
                    this.reset();
                    setType('complaint');
                    selectedPhotos.length = 0;
                    document.getElementById('photo-preview').innerHTML = '';
                    setupLocationDropdowns();
                }catch(err){ alert('Submission failed'); }
            });
        }

        // DC/DM login
        function setupDcdm(){
            document.getElementById('dcdm-login-form').addEventListener('submit', async (e)=>{
                e.preventDefault();
                const pin = document.getElementById('dcdm-pin').value.trim();
                const r = await fetch(`${API}/api/auth/dcdm`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({pin})});
                if(r.ok){ document.getElementById('dcdm-panel').classList.remove('hidden'); loadDcdmList(); }
                else alert('Invalid PIN');
            });
            ['dcdm-type-filter','dcdm-status-filter','dcdm-search'].forEach(id=>{
                const el = document.getElementById(id); el.addEventListener('input', loadDcdmList); el.addEventListener('change', loadDcdmList);
            });
        }

        async function loadDcdmList(){
            const params = {};
            const t = document.getElementById('dcdm-type-filter').value; if(t) params.type=t;
            const s = document.getElementById('dcdm-status-filter').value; if(s) params.status=s;
            const tal = document.getElementById('dcdm-taluk-filter').value; if(tal) params.taluk=tal;
            const fir = document.getElementById('dcdm-firka-filter').value; if(fir) params.firka=fir;
            const vil = document.getElementById('dcdm-village-filter').value; if(vil) params.village=vil;
            const q = document.getElementById('dcdm-search').value.trim(); if(q) params.q=q;
            const items = await listSubmissions(params);
            const active = items.filter(x => x.status !== 'resolved');
            const resolved = items.filter(x => x.status === 'resolved');
            const resolvedBlock = resolved.length ? `<div class=\"card\" style=\"background:#f9fafb\"><h3 style=\"margin-bottom:8px;color:#065f46\">Resolved</h3>${resolved.map(x=>buildCard(x,false)).join('')}</div>` : '';
            document.getElementById('dcdm-list').innerHTML = active.map(x=>buildCard(x,false)).join('') + resolvedBlock;
        }

        // Admin login
        function setupAdmin(){
            document.getElementById('admin-login-form').addEventListener('submit', async (e)=>{
                e.preventDefault();
                const username = document.getElementById('admin-username').value.trim();
                const password = document.getElementById('admin-password').value.trim();
                const r = await fetch(`${API}/api/auth/official`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password})});
                if(r.ok){ isAdmin=true; showSection('admin'); displayAdminList(); }
                else alert('Invalid credentials');
            });
            ['admin-type-filter','admin-status-filter','admin-search-box'].forEach(id=>{
                const el = document.getElementById(id); el.addEventListener('input', displayAdminList); el.addEventListener('change', displayAdminList);
            });
        }

        async function displayAdminList(){
            if(!isAdmin) return;
            const params = {};
            const tf = document.getElementById('admin-type-filter').value; if(tf) params.type=tf;
            const sf = document.getElementById('admin-status-filter').value; if(sf) params.status=sf;
            const tal = document.getElementById('admin-taluk-select').value; if(tal) params.taluk=tal;
            const fir = document.getElementById('admin-firka-select').value; if(fir) params.firka=fir;
            const vil = document.getElementById('admin-village-select').value; if(vil) params.village=vil;
            const q = document.getElementById('admin-search-box').value.trim(); if(q) params.q=q;
            const items = await listSubmissions(params);
            // group resolved separately
            const active = items.filter(x => x.status !== 'resolved');
            const resolved = items.filter(x => x.status === 'resolved');
            const resolvedBlock = resolved.length ? `<div class=\"card\" style=\"background:#f9fafb\"><h3 style=\"margin-bottom:8px;color:#065f46\">Resolved</h3>${resolved.map(x=>buildCard(x,true)).join('')}</div>` : '';
            document.getElementById('admin-complaints-list').innerHTML = active.map(x=>buildCard(x,true)).join('') + resolvedBlock;
        }

        async function updateStatus(id){
            const status = document.getElementById(`st-${id}`).value;
            const response = document.getElementById(`resp-${id}`).value.trim();
            await setStatus(id, status, response || null);
            // fetch latest for this id and render inline live preview
            const latest = await fetch(`${API}/api/submissions/${id}`).then(r=>r.json());
            const live = document.getElementById(`live-${id}`);
            if (latest && live) {
                live.innerHTML = `<div class=\"ack\"><div><strong>Updated:</strong> ${latest.status.replace('-', ' ')}</div><div>${latest.history?.length ? 'Events: '+latest.history.length : ''}</div></div>`;
            }
            // After update, fetch again from server to ensure fresh data
            await Promise.all([displayAdminList(), loadDcdmList(), trackByPhoneAndId().catch(()=>{})]);
        }

        async function trackByPhoneAndId(){
            const phone = document.getElementById('track-phone').value.trim();
            const id = document.getElementById('track-id').value.trim();
            if(!phone || !id){ alert('Enter phone and reference ID'); return; }
            const item = await lookupSubmission(id, phone);
            const area = document.getElementById('track-result');
            if(!item){ area.innerHTML = '<div class="hint">No record found.</div>'; return; }
            area.innerHTML = buildCard(item,false);
        }
        async function downloadTrackAck(){
            const phone = document.getElementById('track-phone').value.trim();
            const id = document.getElementById('track-id').value.trim();
            if(!phone || !id){ alert('Enter phone and reference ID'); return; }
            const item = await lookupSubmission(id, phone);
            if(!item){ alert('No record found'); return; }
            downloadAcknowledgement(id, item);
        }

        function buildAckHtml(item){
            const typeLabel = item.type==='petition' ? 'Petition' : 'Civic Complaint';
            const labelName = item.type==='petition' ? 'Department' : 'Category';
            const labelVal = item.type==='petition' ? getDepartmentLabel(item.department) : getCategoryLabel(item.category);
            const submitted = new Date(item.timestamp).toLocaleString();
            const location = `${item.taluk} / ${item.firka} / ${item.village}`;
            return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Acknowledgement ${item.id}</title>
                <style>body{font-family:Arial;padding:24px}.wrap{max-width:720px;margin:0 auto}.box{border:1px solid #ddd;border-radius:8px;padding:16px}.row{display:flex;gap:12px;margin:6px 0}.k{width:160px;color:#555}.v{font-weight:600}@media print{.noprint{display:none}}</style>
            </head><body><div class="wrap">
                <h2>Tenkasi District Administration</h2>
                <div>Digital Petition Redressal Mechanism</div>
                <div class="box">
                    <div class="row"><div class="k">Reference ID</div><div class="v">${item.id}</div></div>
                    <div class="row"><div class="k">Type</div><div class="v">${typeLabel}</div></div>
                    <div class="row"><div class="k">${labelName}</div><div class="v">${labelVal}</div></div>
                    <div class="row"><div class="k">Name</div><div class="v">${item.name}</div></div>
                    <div class="row"><div class="k">Phone</div><div class="v">${item.phone}</div></div>
                    ${item.email?`<div class="row"><div class="k">Email</div><div class="v">${item.email}</div></div>`:''}
                    <div class="row"><div class="k">Location</div><div class="v">${location}</div></div>
                    <div class="row"><div class="k">Urgency</div><div class="v">${getUrgencyLabel(item.urgency)}</div></div>
                    <div class="row"><div class="k">Submitted</div><div class="v">${submitted}</div></div>
                    <div class="row"><div class="k">Status</div><div class="v">${item.status.replace('-',' ')}</div></div>
                    <div style="margin-top:10px"><div class="k" style="color:#555">Description</div><div>${item.description}</div></div>
                </div>
                <div class="noprint" style="margin-top:10px;"><button onclick="window.print()">Print / Save as PDF</button></div>
            </div></body></html>`;
        }
        async function downloadAcknowledgement(id, preItem){
            const item = preItem || (await listSubmissions({ q: id })).find(x=>x.id===id);
            if(!item){ alert('No submission found for ID: '+id); return; }
            const w = window.open('', '_blank'); if (!w) { alert('Popup blocked'); return; }
            w.document.open(); w.document.write(buildAckHtml(item)); w.document.close();
        }

        function init(){
            setType('complaint');
            setupPhotoInput();
            setupLocationDropdowns();
            setupDcdmLocation();
            setupAdminLocation();
            setupForm();
            setupDcdm();
            setupAdmin();
            showSection('public');
        }
        document.addEventListener('DOMContentLoaded', ()=>{ init(); setLang('en'); });
    </script>
</body>
</html>